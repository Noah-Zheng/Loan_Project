---
title: "Loan_Project"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=10,fig.height=7,fig.path='Figs/',
                      fig.align='center',tidy=TRUE,
                      echo=FALSE,warning=FALSE,message=FALSE)
```



# Prosper Loan Project 

## Background Information 
The dataset is from Prosper, an American company in the peer-to-peer lending industry. Prosper maintains a full public database of all loans issued through its marketplace on its website. This database and all market statistics can be accessed and queried for analysis of loan performance over time. 

## Source 
1. https://en.wikipedia.org/wiki/Prosper_Marketplace#cite_note-Prosper_Marketplace,_Inc-6 
2. https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit#gid=0 
3. https://www.wikihow.com/Invest-on-Prosper.com

## Process
1. Overview of the data
2. Analysis
  * Univariateanalysis and plots
  * Bivariate analysis and plots
  * Multivariate analysis and plots
3. Final plots and summary
4. reflection


## Overview of the Data

From Udacity:

*This data set contains 113,937 loans with 81 variables on each loan, including loan amount, borrower rate (or interest rate), current loan status, borrower income, borrower employment status, borrower credit history, and the latest payment information.*

### Main Features of Interest

ListingCreationDate
Term
LoanStatus
BorrowerRate
LeanderYield
ProsperRating(numeric)
ProsperScore
ListingCategory
BorrowerState
IsBorrowerHomeowner
DebtToIncomeRatio
LoanOriginalAmount 
Investors


## Exploratory Analysis

```{r }
#import the data
dd <- read.csv("prosperLoanData.csv")

```

### Univariate analysis 

```{r }
#Select columns
library(dplyr)
cols <- c('ListingCreationDate', 'Term', 'LoanStatus', 'BorrowerRate',
          'LenderYield', 'ProsperRating..numeric.', 'ProsperScore',
          'ListingCategory..numeric.', 'BorrowerState',
          'IsBorrowerHomeowner', 'DebtToIncomeRatio',
          'LoanOriginalAmount', 'Investors')

dd_s <- select(dd, cols)

```
#### The Structure of the Data 

```{r }
#structure of the data
str(dd_s)
summary(dd_s)
```

Firtly, I am interested in the listing over the time. Therefore, I generate the following plot.

```{r }
#ggpair, univariate plot
library(ggplot2)

#convert date time to date
library(anytime)
dd_s$ListingCreationDate <- anytime(dd_s$ListingCreationDate)
dd_s$ListingCreationDate <- as.Date(dd_s$ListingCreationDate, format = "%Y/%m")

str(dd_s)

#https://stackoverflow.com/questions/11748384/formatting-dates-on-x-axis-in-ggplot2
#https://stackoverflow.com/questions/41855673/r-ggplot-display-all-dates-on-x-axis
library(scales)
library(ggpubr)
ggplot(dd_s, aes(x = ListingCreationDate)) +
  geom_histogram() +
  theme_bw() +
  labs(x = 'month', y = 'Number of Listing') +
  scale_x_date(labels = date_format("%y-%m"), date_breaks = "2 month") +
  ggpubr::rotate_x_text()

```

It can be noticed that there is a big drop in listing from 2008-09. It takes almost 3 years for the listing to recover to 2008-07 level. What happened in September of 2008 relating to finance is the collapse of Lehman Brothers on September 15. Another information is of interest is that the Prosper rating is introduced in July 2009, when the listing starts to increase. Another sharp decline happened in 2014-03. It can be explored further with other information. 


### The Term of Loans 

```{r}
#bar plot of terms
ggplot(dd_s, aes(x=factor(Term))) +
  geom_bar()
```
 
The majority of loans are with a term of 36 months. Loans with 12 months are quite small. Around 25000 loans are with a 60 months term. 


#### Loan Status
```{r}
ggplot(dd_s, aes(x = LoanStatus)) +
  geom_bar() + 
  geom_text(stat = 'count', aes(label = ..count..), vjust=-1) +
  ggpubr::rotate_x_text()
```

The majority of loans are current. The second is completed. The third is charged off. The fourth is defaulted. 


#### The Borrower Rate

```{r}
ggplot(dd_s, aes(x = BorrowerRate)) +
  geom_histogram()
```

The distribution of borrower rate is right skewed with median 0.1840 < mean 0.1928. 

```{r}
summary(dd_s$BorrowerRate)
```


#### Lender Yield
```{r}
ggplot(dd_s, aes(x = LenderYield)) +
  geom_histogram()
```

As lender yield is equal to the interest rate on the loan less the servicing fee, the shape is essentially the same as borrower rate. 

```{r}
summary(dd_s$LenderYield)
```

#### Prosper Rating 

```{r}
ggplot(dd_s, aes(x=factor(ProsperRating..numeric.))) +
  geom_bar()
```
 
The distribution of rating is close to a normal distribution except for the NA which is because that the Prosper rating is introduced in July 2009.

#### Prosper Score
```{r}
ggplot(dd_s, aes(x = ProsperScore)) +
  geom_histogram() +
  scale_x_continuous(breaks = seq(1,11,1))
```

```{r}
summary(dd_s$ProsperScore)
```

The distributinon of Prosper Score is of bell shape with a median of 6 and mean of 5.95.


#### Listing Category

The category of the listing that the borrower selected when posting their listing: 0 - Not Available, 1 - Debt Consolidation, 2 - Home Improvement, 3 - Business, 4 - Personal Loan, 5 - Student Use, 6 - Auto, 7- Other, 8 - Baby&Adoption, 9 - Boat, 10 - Cosmetic Procedure, 11 - Engagement Ring, 12 - Green Loans, 13 - Household Expenses, 14 - Large Purchases, 15 - Medical/Dental, 16 - Motorcycle, 17 - RV, 18 - Taxes, 19 - Vacation, 20 - Wedding Loans   

```{r}
#https://stackoverflow.com/questions/10002536/how-do-i-replace-numeric-codes-with-value-labels-from-a-lookup-table

a <- 0:20
names(a) <- c('Not Available', 'Debt Consolidation', 'Home Improvement', 'Business', 'Personal Loan', 'Student Use', 'Auto', 'Other', 'Baby&Adoption', 'Boat', 'Cosmetic Procedure', 'Engagement Ring', 'Green Loans', 'Household Expenses', 'Large Purchases', 'Medical/Dental', 'Motorcycle', 'RV', 'Taxes', 'Vacation', 'Wedding Loans')

dd_s$ListingCategory..numeric. <- names(a)[match(dd_s$ListingCategory..numeric., a)]
```


```{r}
#https://stackoverflow.com/questions/37853539/how-to-draw-sorted-frequency-barplot-with-ggplot-in-r

ggplot(dd_s, aes(x = reorder(ListingCategory..numeric., ListingCategory..numeric., function(x) -length(x)))) +
  geom_bar() +
  xlab("Category") +
  ggpubr::rotate_x_text()

```

Most of the listing falls in Debt Consolidation.


#### Borrowing State

```{r}
ggplot(dd_s, 
       aes(x=reorder(BorrowerState, BorrowerState, function(x) - length(x))
           )
       ) +
  xlab('state') +
  geom_bar()
```

California has the most listings. 

#### Borrower a Home Owner

```{r}
ggplot(dd_s, aes(x = IsBorrowerHomeowner)) +
  geom_bar()

```

```{r}
summary(dd_s$IsBorrowerHomeowner)
```

There are around 1000 more home owners.

#### Debt to Income Ratio

```{r}
ggplot(dd_s, aes(x = DebtToIncomeRatio)) +
  geom_histogram()
```

```{r}
summary(dd_s$DebtToIncomeRatio)
```

More than 75% of the listings have a debt to income ratio less than 0.32.


#### Loan Amount 

```{r }
#plot of LoanOriginalAmount
ggplot(dd_s, aes(x = LoanOriginalAmount)) +
  geom_histogram()
```
 


```{r}
summary(dd_s$LoanOriginalAmount)
```

 
It shows a right skewed trend, mean 8447 > median 6500. 

#### Investors
```{r}
ggplot(dd_s, aes(x = Investors)) +
  geom_histogram()
```

```{r}
summary(dd_s$Investors)
```

It is right skewed with a median of 44 and mean of 80.48.


### Univariate Analysis


### The Relationship between the Yield and Rating 

```{r }
ggplot(dd_s, aes(ProsperRating, LenderYield)) +
  geom_point(alpha = 1/50, position = position_jitter())
```
 
It can be noticed that the yield decreases when rating increases. Listings with 1 and 4 have noticiable yield differ from the majority. 

A line plot to show the trend. 

```{r }
ggplot(dd_s, aes(ProsperRating, LenderYield)) +
  geom_line(stat = "summary", fun.y = "mean")
```
 
A strong negative relationship between the average yield and rating exists. 

Group by different loan status. 

```{r }
ggplot(dd_s, aes(ProsperRating, LenderYield)) +
  geom_line(aes(color = LoanStatus), stat = "summary", fun.y = mean)
```
 
Too many lines. Group all the past due into one catagory.

```{r }
#combine all past dues in one level 
dd_s$Status <- dd_s$LoanStatus
#find out the index of the past due levels
#levels(dd_s$Status)
levels(dd_s$Status)[7:12] <- "Past Due"
#check the result
#levels(dd_s$Status)
```
 
Line plot wiht one past due. 

```{r}
ggplot(dd_s, aes(ProsperRating, LenderYield)) +
  geom_line(aes(color = Status), stat = "summary", fun.y = mean)
```
 
Different status shows the same trend.


### Exploring the Rrelationship between Yield and Loan Amount 

```{r}
#scatter plot of the relationship between yield and loan amount
ggplot(dd_s, aes(LoanOriginalAmount, LenderYield)) +
  geom_point(alpha = 1/50, position = position_jitter())
```
 
The average yield seems to decrease when the amount increases. 

Add a smooth line in the scatter plot. 

```{r }
#add a smooth line in the scatter plot 
ggplot(dd_s, aes(LoanOriginalAmount, LenderYield)) +
  geom_point(alpha = 1/50, position = position_jitter())+
  geom_smooth(color = "red")
```

No clear pattern.

### Exploring the Distribution of Yield in Different Loan Status. 

```{r }
qplot(data=dd_s, LenderYield) +
  facet_wrap(~Status, scales="free")
```

There is a relative big number of listings with yield more than 0.3 in all the loan status levels except current. 


### The Relationship between Loan Amount and Rating. 

```{r }
ggplot(dd_s, aes(ProsperRating, LoanOriginalAmount)) +
  geom_point(alpha = 1/50, position = position_jitter())
```

Listings with high risk tends to have low amount that that with low risk. 
 
Use line pot to see the trend.

```{r }
ggplot(dd_s, aes(ProsperRating, LoanOriginalAmount)) +
  geom_line(stat = "summary", fun.y = "mean") +
  ylim(0,quantile(dd_s$LoanOriginalAmount, .99))
```

The average loan amount for listings with rating of 1 is around 3000, increasing to more than 10000 with rating 4. 

Group by loan status.

```{r }
ggplot(dd_s, aes(ProsperRating, LoanOriginalAmount)) +
  geom_line(aes(color = Status), stat = "summary", fun.y = "mean") +
  ylim(0,quantile(dd_s$LoanOriginalAmount, .99))
```


```{r }
ggplot(dd_s, aes(ProsperRating, LoanOriginalAmount)) +
  geom_point(alpha = 1/100, position = position_jitter()) +
  geom_line(aes(color = Status), stat = "summary", fun.y = "mean") +
  ylim(0,quantile(dd_s$LoanOriginalAmount, .99))
```

Put together the point plot and line plot to show the relationship between loan amount and prosper rating. 

## Final Plots and Summary

### Plot 1
```{r }
ggplot(dd_s, aes(ProsperRating, LenderYield)) +
  geom_line(aes(color = Status), stat = "summary", fun.y = mean)+
  ggtitle("Relationship Between Yield and Rating") +
  ylab("LenderYield(%)")

```

As guessed in the question part, there is a strong negative relationship between the rating and yield, highest rating with lowest yield. All status show the same trend.

### Plot 2
```{r }
qplot(data=dd_s, LenderYield) +
  facet_wrap(~Status, scales="free")+
  ggtitle("LenderYield in Different Status") +
  ylab("count")
```

High yield means high risk. Therefore, there can be expected more loan with high yield in status of charged off, defaulted and past due.  It is interesting to find that in the completed and current status, there is quit an amount of listings with 0.3 yield.

### Plot 3
```{r }
ggplot(dd_s, aes(ProsperRating, LoanOriginalAmount)) +
  geom_point(alpha = 1/100, position = position_jitter()) +
  geom_line(aes(color = Status), stat = "summary", fun.y = "mean") +
  ylim(0,quantile(dd_s$LoanOriginalAmount, .99)) +
  ggtitle("Relationship Between Loan Amount and Rating") +
  ylab("Loan Amount(USD)")
```

Listing with low risk will have higher average loan amount.

## Reflection
It is very hard to ask a beautiful question. The main question in this analysis is very simple: the relationship between the lender yield and prosper rating of the loan. As expected, it is a negative relationship.  
 
It is hard to find other meaningful insights into the relatinships between those variables. It is intersting to find out that there is a positive relationship between the loan amount and rating. I expected that lower amount has higher rating. Then I put myself in the shoes of a borrower and I realised that I will only borrow large amount of money when I am confident that I will get the loan which means I assess myself with a higher rating and lower risk. 
 

