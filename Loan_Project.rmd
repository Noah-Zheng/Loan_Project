---
title: "Loan_Project"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


# Loan Project 

## Background Information 
The dataset is from Prosper, an American company in the peer-to-peer lending industry. Prosper maintains a full public database of all loans issued through its marketplace on its website. This database and all market statistics can be accessed and queried for analysis of loan performance over time. 

## Source 
1. https://en.wikipedia.org/wiki/Prosper_Marketplace#cite_note-Prosper_Marketplace,_Inc-6 
2. https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit#gid=0 
3. https://www.wikihow.com/Invest-on-Prosper.com

## Question
It is so hard to ask a good question. 
As a defensive investor, I would like to know the relationship between the Prosper rating and yield which I expect to be nagative.  

The income of the borrower is not reliable as borrowers would likely to overstate their income in order to get a loan. Therefore, the following factors are choosen.  

6 Term
7 LoanStatus
11 LeanderYield
15 ProsperRating(numeric)
65 LoanOriginalAmount 

## Exploring

```{r message=FALSE, warning=FALSE}
#import the data
dd <- read.csv("prosperLoanData.csv")

```


```{r message=FALSE, warning=FALSE}
#Select columns
library(dplyr)
dd_s <- select(dd, "Term","LoanStatus","LenderYield","ProsperRating..numeric.","LoanOriginalAmount")

#change column name "ProsperRating(numeric)" to "ProsperRating"
colnames(dd_s)[4] = "ProsperRating"

#select data after 2009
dd_s <- subset(dd_s, !is.na(ProsperRating))
```
### The Structure of the Data 

```{r message=FALSE, warning=FALSE}
#structure of the data
str(dd_s)
summary(dd_s)
```
### GGplot of all variables 

```{r message=FALSE, warning=FALSE}
#ggpair, univariate plot
library(ggplot2)
library(GGally)
ggpairs(dd_s)
ggsave("univariateplot.png")

```
Observations: 

1. It seems there is no relationship between the yield and loan term.
2. There is a strong negative relationship between ProsperRating and LenderYield.
3. There is negative relationship between the loan amount and yield.
4. Loan amount and rating has positive relationship.
 

### The Term of Loans 

```{r}
#bar plot of terms
ggplot(dd_s, aes(x=factor(Term))) +
  geom_bar()
```
 
The majority of loans are with a term of 36 months.

 
### Loan Amount 

```{r message=FALSE, warning=FALSE}
#plot of LoanOriginalAmount
ggplot(dd_s, aes(x = LoanOriginalAmount)) +
  geom_histogram()
```
 
It shows a right skewed trend. 

 
Add a non-linear scaling to the plot 

```{r message=FALSE, warning=FALSE}
ggplot(dd_s, aes(x = LoanOriginalAmount)) +
  geom_histogram() +
  scale_x_log10()
```
 
It is close to one bell shape after using non-linear scaling. 
 
### The Distibution of Yield 

```{r message=FALSE, warning=FALSE}
ggplot(dd_s, aes(x = LenderYield)) +
  geom_histogram()
```
 
The distribution of LenderYield is like a normal distribution.

### Prosper Rating 

```{r}
ggplot(dd_s, aes(x=factor(ProsperRating))) +
  geom_bar()
```
 
The distribution of rating is close to a normal distribution.

### The Relationship between the Yield and Rating 

```{r message=FALSE, warning=FALSE}
ggplot(dd_s, aes(ProsperRating, LenderYield)) +
  geom_point(alpha = 1/50, position = position_jitter())
```
 
It can be noticed that the yield decreases when rating increases. Listings with 1 and 4 have noticiable yield differ from the majority. 

A line plot to show the trend. 

```{r message=FALSE, warning=FALSE}
ggplot(dd_s, aes(ProsperRating, LenderYield)) +
  geom_line(stat = "summary", fun.y = "mean")
```
 
A strong negative relationship between the average yield and rating exists. 

Group by different loan status. 

```{r message=FALSE, warning=FALSE}
ggplot(dd_s, aes(ProsperRating, LenderYield)) +
  geom_line(aes(color = LoanStatus), stat = "summary", fun.y = mean)
```
 
Too many lines. Group all the past due into one catagory.

```{r message=FALSE, warning=FALSE}
#combine all past dues in one level 
dd_s$Status <- dd_s$LoanStatus
#find out the index of the past due levels
#levels(dd_s$Status)
levels(dd_s$Status)[7:12] <- "Past Due"
#check the result
#levels(dd_s$Status)
```
 
Line plot wiht one past due. 

```{r}
ggplot(dd_s, aes(ProsperRating, LenderYield)) +
  geom_line(aes(color = Status), stat = "summary", fun.y = mean)
```
 
Different status shows the same trend.


### Exploring theRrelationship between Yield and Loan Amount 

```{r}
#scatter plot of the relationship between yield and loan amount
ggplot(dd_s, aes(LoanOriginalAmount, LenderYield)) +
  geom_point(alpha = 1/50, position = position_jitter())
```
 
The average yield seems to decrease when the amount increases. 

Add a smooth line in the scatter plot. 

```{r message=FALSE, warning=FALSE}
#add a smooth line in the scatter plot 
ggplot(dd_s, aes(LoanOriginalAmount, LenderYield)) +
  geom_point(alpha = 1/50, position = position_jitter())+
  geom_smooth(color = "red")
```

No clear pattern.

### Exploring the Distribution of Yield in Different Loan Status. 

```{r message=FALSE, warning=FALSE}
qplot(data=dd_s, LenderYield) +
  facet_wrap(~Status, scales="free")
```

There is a relative big number of listings with yield more than 0.3 in all the loan status levels except current. 


### The Relationship between Loan Amount and Rating. 

```{r message=FALSE, warning=FALSE}
ggplot(dd_s, aes(ProsperRating, LoanOriginalAmount)) +
  geom_point(alpha = 1/50, position = position_jitter())
```

Listings with high risk tends to have low amount that that with low risk. 
 
Use line pot to see the trend.

```{r message=FALSE, warning=FALSE}
ggplot(dd_s, aes(ProsperRating, LoanOriginalAmount)) +
  geom_line(stat = "summary", fun.y = "mean") +
  ylim(0,quantile(dd_s$LoanOriginalAmount, .99))
```

The average loan amount for listings with rating of 1 is around 3000, increasing to more than 10000 with rating 4. 

Group by loan status.

```{r message=FALSE, warning=FALSE}
ggplot(dd_s, aes(ProsperRating, LoanOriginalAmount)) +
  geom_line(aes(color = Status), stat = "summary", fun.y = "mean") +
  ylim(0,quantile(dd_s$LoanOriginalAmount, .99))
```


```{r message=FALSE, warning=FALSE}
ggplot(dd_s, aes(ProsperRating, LoanOriginalAmount)) +
  geom_point(alpha = 1/100, position = position_jitter()) +
  geom_line(aes(color = Status), stat = "summary", fun.y = "mean") +
  ylim(0,quantile(dd_s$LoanOriginalAmount, .99))
```

Put together the point plot and line plot to show the relationship between loan amount and prosper rating. 

## Final Plots and Summary

### Plot 1
```{r message=FALSE, warning=FALSE}
ggplot(dd_s, aes(ProsperRating, LenderYield)) +
  geom_line(aes(color = Status), stat = "summary", fun.y = mean)+
  ggtitle("Relationship Between Yield and Rating") +
  ylab("LenderYield(%)")

```

As guessed in the question part, there is a strong negative relationship between the rating and yield, highest rating with lowest yield. All status show the same trend.

### Plot 2
```{r message=FALSE, warning=FALSE}
qplot(data=dd_s, LenderYield) +
  facet_wrap(~Status, scales="free")+
  ggtitle("LenderYield in Different Status") +
  ylab("count")
```

High yield means high risk. Therefore, there can be expected more loan with high yield in status of charged off, defaulted and past due.  It is interesting to find that in the completed and current status, there is quit an amount of listings with 0.3 yield.

### Plot 3
```{r message=FALSE, warning=FALSE}
ggplot(dd_s, aes(ProsperRating, LoanOriginalAmount)) +
  geom_point(alpha = 1/100, position = position_jitter()) +
  geom_line(aes(color = Status), stat = "summary", fun.y = "mean") +
  ylim(0,quantile(dd_s$LoanOriginalAmount, .99)) +
  ggtitle("Relationship Between Loan Amount and Rating") +
  ylab("Loan Amount(USD)")
```

Listing with low risk will have higher average loan amount.

## Reflection
It is very hard to ask a beautiful question. The main question in this analysis is very simple: the relationship between the lender yield and prosper rating of the loan. As expected, it is a negative relationship.  
 
It is hard to find other meaningful insights into the relatinships between those variables. It is intersting to find out that there is a positive relationship between the loan amount and rating. I expected that lower amount has higher rating. Then I put myself in the shoes of a borrower and I realised that I will only borrow large amount of money when I am confident that I will get the loan which means I assess myself with a higher rating and lower risk. 
 

